var game={data:{score:0,steps:0,start:false,newHiScore:false},onload:function(){if(!me.video.init("screen",900,600,true,"auto")){alert("Your browser does not support HTML5 canvas.");return}me.audio.init("mp3,ogg");me.loader.onload=this.loaded.bind(this);me.loader.preload(game.resources);me.state.change(me.state.LOADING)},loaded:function(){me.state.set(me.state.MENU,new game.TitleScreen());me.state.set(me.state.PLAY,new game.PlayScreen());me.state.set(me.state.GAME_OVER,new game.GameOverScreen());me.input.bindKey(me.input.KEY.SPACE,"fly",true);me.input.bindTouch(me.input.KEY.SPACE);me.pool.register("clumsy",BirdEntity);me.pool.register("pipe",PipeEntity,true);me.pool.register("hit",HitEntity,true);me.game.viewport.setBounds(0,0,900,600);me.state.change(me.state.MENU)}};game.HUD=game.HUD||{};game.HUD.Container=me.ObjectContainer.extend({init:function(){this.parent();this.isPersistent=true;this.collidable=false;this.z=Infinity;this.name="HUD";this.addChild(new game.HUD.ScoreItem(5,5))}});game.HUD.ScoreItem=me.Renderable.extend({init:function(a,b){this.parent(new me.Vector2d(a,b),10,10);this.stepsFont=new me.Font("gamefont",80,"#000","center");this.floating=true},update:function(){return true},draw:function(a){if(game.data.start&&me.state.isCurrent(me.state.PLAY)){this.stepsFont.draw(a,game.data.steps,me.video.getWidth()/2,10)}}});var BackgroundLayer=me.ImageLayer.extend({init:function(b,c,a){name=b;width=900;height=600;ratio=1;this.fixed=a>0?false:true;this.parent(name,width,height,b,c,ratio)},update:function(){if(!this.fixed){if(this.pos.x>=this.imagewidth-1){this.pos.x=0}this.pos.x+=this.speed}return true}});var BirdEntity=me.ObjectEntity.extend({init:function(a,c){var b={};b.image=me.loader.getImage("clumsy");b.width=85;b.height=60;b.spritewidth=85;b.spriteheight=60;this.parent(a,c,b);this.alwaysUpdate=true;this.gravity=0.2;this.gravityForce=0.01;this.maxAngleRotation=Number.prototype.degToRad(30);this.maxAngleRotationDown=Number.prototype.degToRad(90);this.renderable.addAnimation("flying",[0,1,2]);this.renderable.addAnimation("idle",[0]);this.renderable.setCurrentAnimation("flying");this.animationController=0;this.addShape(new me.Rect(new me.Vector2d(5,5),70,50));this.flyTween=new me.Tween(this.pos);this.flyTween.easing(me.Tween.Easing.Exponential.InOut)},update:function(e){if(game.data.start){if(me.input.isKeyPressed("fly")){this.gravityForce=0.01;var b=this.pos.y;this.flyTween.stop();this.flyTween.to({y:b-72},100);this.flyTween.start();this.renderable.angle=-this.maxAngleRotation}else{this.gravityForce+=0.2;this.pos.y+=me.timer.tick*this.gravityForce;this.renderable.angle+=Number.prototype.degToRad(3)*me.timer.tick;if(this.renderable.angle>this.maxAngleRotationDown){this.renderable.angle=this.maxAngleRotationDown}}}var a=me.game.collide(this);if(a){if(a.obj.type!="hit"){me.device.vibrate(500);me.state.change(me.state.GAME_OVER);return false}me.game.world.removeChildNow(a.obj);game.data.steps++;me.audio.play("hit")}else{var d=me.game.viewport.height-(96+60);var c=-80;if(this.pos.y>=d||this.pos.y<=c){me.state.change(me.state.GAME_OVER);return false}}return this.parent(e)},});var PipeEntity=me.ObjectEntity.extend({init:function(a,c){var b={};b.image=me.loader.getImage("pipe");b.width=148;b.height=1664;b.spritewidth=148;b.spriteheight=1664;this.parent(a,c,b);this.alwaysUpdate=true;this.gravity=5;this.updateTime=false},update:function(a){this.pos.add(new me.Vector2d(-this.gravity*me.timer.tick,0));if(this.pos.x<-148){me.game.world.removeChild(this)}return true},});var PipeGenerator=me.Renderable.extend({init:function(){this.parent(new me.Vector2d(),me.game.viewport.width,me.game.viewport.height);this.alwaysUpdate=true;this.generate=0;this.pipeFrequency=92;this.pipeHoleSize=1240;this.posX=me.game.viewport.width},update:function(d){if(this.generate++%this.pipeFrequency==0){var f=Number.prototype.random(me.video.getHeight()-100,200);var c=f-me.video.getHeight()-this.pipeHoleSize;var b=new me.pool.pull("pipe",this.posX,f);var a=new me.pool.pull("pipe",this.posX,c);var g=f-100;var e=new me.pool.pull("hit",this.posX,g);b.renderable.flipY();me.game.world.addChild(b,10);me.game.world.addChild(a,10);me.game.world.addChild(e,11)}return true},});var HitEntity=me.ObjectEntity.extend({init:function(a,c){var b={};b.image=me.loader.getImage("hit");b.width=148;b.height=60;b.spritewidth=148;b.spriteheight=60;this.parent(a,c,b);this.alwaysUpdate=true;this.gravity=5;this.updateTime=false;this.type="hit";this.renderable.alpha=0;this.ac=new me.Vector2d(-this.gravity,0)},update:function(){this.pos.add(this.ac);if(this.pos.x<-148){me.game.world.removeChild(this)}return true},});var Ground=me.ObjectEntity.extend({init:function(a,c){var b={};b.image=me.loader.getImage("ground");b.width=900;b.height=96;this.parent(a,c,b);this.alwaysUpdate=true;this.gravity=0;this.updateTime=false;this.accel=new me.Vector2d(-4,0)},update:function(){this.pos.add(this.accel);if(this.pos.x<-this.renderable.width){this.pos.x=me.video.getWidth()-10}return true},});var TheGround=Object.extend({init:function(){this.ground1=new Ground(0,me.video.getHeight()-96);this.ground2=new Ground(me.video.getWidth(),me.video.getHeight()-96);me.game.world.addChild(this.ground1,11);me.game.world.addChild(this.ground2,11)},update:function(){return true}});game.resources=[{name:"bg",type:"image",src:"data/img/bg.png"},{name:"clumsy",type:"image",src:"data/img/clumsy.png"},{name:"pipe",type:"image",src:"data/img/pipe.png"},{name:"logo",type:"image",src:"data/img/logo.png"},{name:"ground",type:"image",src:"data/img/ground.png"},{name:"gameover",type:"image",src:"data/img/gameover.png"},{name:"gameoverbg",type:"image",src:"data/img/gameoverbg.png"},{name:"hit",type:"image",src:"data/img/hit.png"},{name:"getready",type:"image",src:"data/img/getready.png"},{name:"new",type:"image",src:"data/img/new.png"},{name:"theme",type:"audio",src:"data/bgm/"},{name:"hit",type:"audio",src:"data/sfx/"},{name:"lose",type:"audio",src:"data/sfx/"},];game.GameOverScreen=me.ScreenObject.extend({init:function(){this.savedData=null;this.handler=null},onResetEvent:function(){me.audio.play("lose");this.savedData={score:game.data.score,steps:game.data.steps};me.save.add(this.savedData);if(!me.save.topSteps){me.save.add({topSteps:game.data.steps})}if(game.data.steps>me.save.topSteps){me.save.topSteps=game.data.steps;game.data.newHiScore=true}me.input.bindKey(me.input.KEY.ENTER,"enter",true);me.input.bindKey(me.input.KEY.SPACE,"enter",false);me.input.bindMouse(me.input.mouse.LEFT,me.input.KEY.ENTER);this.handler=me.event.subscribe(me.event.KEYDOWN,function(e,f,d){if(e==="enter"){me.state.change(me.state.MENU)}});var b=me.loader.getImage("gameover");me.game.world.addChild(new me.SpriteObject(me.video.getWidth()/2-b.width/2,me.video.getHeight()/2-b.height/2-100,b),12);var a=me.loader.getImage("gameoverbg");me.game.world.addChild(new me.SpriteObject(me.video.getWidth()/2-a.width/2,me.video.getHeight()/2-a.height/2,a),10);me.game.world.addChild(new BackgroundLayer("bg",1));this.ground=new TheGround();me.game.world.addChild(this.ground,11);if(game.data.newHiScore){var c=new me.SpriteObject(235,355,me.loader.getImage("new"));me.game.world.addChild(c,12)}this.dialog=new (me.Renderable.extend({init:function(){this.parent(new me.Vector2d(),100,100);this.font=new me.Font("gamefont",40,"black","left");this.steps="Steps: "+game.data.steps.toString();this.topSteps="Higher Step: "+me.save.topSteps.toString()},update:function(){return true},draw:function(f){var d=this.font.measureText(f,this.steps);var g=this.font.measureText(f,this.topSteps);var e=this.font.measureText(f,this.score);this.font.draw(f,this.steps,me.game.viewport.width/2-d.width/2-60,me.game.viewport.height/2);this.font.draw(f,this.topSteps,me.game.viewport.width/2-d.width/2-60,me.game.viewport.height/2+50)}}));me.game.world.addChild(this.dialog,12)},onDestroyEvent:function(){me.event.unsubscribe(this.handler);me.input.unbindKey(me.input.KEY.ENTER);me.input.unbindKey(me.input.KEY.SPACE);me.input.unbindMouse(me.input.mouse.LEFT);me.game.world.removeChild(this.ground);this.font=null;me.audio.stop("theme")}});game.PlayScreen=me.ScreenObject.extend({init:function(){me.audio.play("theme",true);var a=me.device.ua.contains("Firefox")?0.3:0.5;me.audio.setVolume(a);this.parent(this)},onResetEvent:function(){me.audio.stop("theme");me.audio.play("theme",true);me.input.bindKey(me.input.KEY.SPACE,"fly",true);game.data.score=0;game.data.steps=0;game.data.start=false;game.data.newHiscore=false;me.game.world.addChild(new BackgroundLayer("bg",1));this.ground=new TheGround();me.game.world.addChild(this.ground,11);this.HUD=new game.HUD.Container();me.game.world.addChild(this.HUD);this.bird=me.pool.pull("clumsy",60,me.game.viewport.height/2-100);me.game.world.addChild(this.bird,10);me.input.bindMouse(me.input.mouse.LEFT,me.input.KEY.SPACE);this.getReady=new me.SpriteObject(me.video.getWidth()/2-200,me.video.getHeight()/2-100,me.loader.getImage("getready"));me.game.world.addChild(this.getReady,11);var a=new me.Tween(this.getReady).to({alpha:0},2000).easing(me.Tween.Easing.Linear.None).onComplete(function(){game.data.start=true;me.game.world.addChild(new PipeGenerator(),0)}).start()},onDestroyEvent:function(){me.audio.stopTrack("theme");this.HUD=null;this.bird=null;me.input.unbindKey(me.input.KEY.SPACE)}});game.TitleScreen=me.ScreenObject.extend({init:function(){this.font=null},onResetEvent:function(){me.audio.stop("theme");game.data.newHiScore=false;me.game.world.addChild(new BackgroundLayer("bg",1));me.input.bindKey(me.input.KEY.ENTER,"enter",true);me.input.bindKey(me.input.KEY.SPACE,"enter",true);me.input.bindMouse(me.input.mouse.LEFT,me.input.KEY.ENTER);this.handler=me.event.subscribe(me.event.KEYDOWN,function(e,f,d){if(e==="enter"){me.state.change(me.state.PLAY)}});var b=me.loader.getImage("logo");var c=new me.SpriteObject(me.game.viewport.width/2-170,-b,b);me.game.world.addChild(c,10);var a=new me.Tween(c.pos).to({y:me.game.viewport.height/2-100},1000).easing(me.Tween.Easing.Exponential.InOut).start();this.ground=new TheGround();me.game.world.addChild(this.ground,11);me.game.world.addChild(new (me.Renderable.extend({init:function(){this.parent(new me.Vector2d(),100,100);this.text=me.device.touch?"Tap to start":"PRESS SPACE OR CLICK LEFT MOUSE BUTTON TO START";this.font=new me.Font("gamefont",20,"#000")},update:function(){return true},draw:function(d){var e=this.font.measureText(d,this.text);this.font.draw(d,this.text,me.game.viewport.width/2-e.width/2,me.game.viewport.height/2+50)}})),12)},onDestroyEvent:function(){me.event.unsubscribe(this.handler);me.input.unbindKey(me.input.KEY.ENTER);me.input.unbindKey(me.input.KEY.SPACE);me.input.unbindMouse(me.input.mouse.LEFT);me.game.world.removeChild(this.ground)}});